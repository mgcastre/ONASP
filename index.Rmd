---
title: "ONASP"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: cerulean
runtime: shiny
---

```{r global, include=FALSE}
# Load Required Libraries
library(sp)
library(DBI)
library(rgdal)
library(RSQLite)
library(tidyverse)
library(htmltools)
library(lubridate)
library(shinyWidgets)
library(RColorBrewer)
library(flexdashboard)
library(rsconnect)
library(magrittr)
library(leaflet)
library(leafpop)
library(plotly)
library(shiny)

# Read shapefiles from database
shpDB <- "./data/PanamaShapefiles.sqlite"
rivers <- readOGR(dsn=shpDB, layer="rivers_main_2011", verbose=F, use_iconv=T, encoding="UTF-8")
geology <- readOGR(dsn=shpDB, layer="geologic_formations_1990", verbose=F, use_iconv=T, encoding="UTF-8")
watersheds <- readOGR(dsn=shpDB, layer="watersheds_2012", verbose=F, use_iconv=T, encoding="UTF-8")

# Open database connection and read tables
objDB <- dbConnect(drv=SQLite(), dbname="./data/Estibana_v5.1.sqlite")
Head_Data <- dbReadTable(objDB, "Head_Data")
Head_Points <- dbReadTable(objDB, "Head_Points")
rglocs <- dbReadTable(objDB, "Precipitation_Locations")
rgdata <- dbReadTable(objDB, "Precipitation_Measurements")
dbDisconnect(objDB)

# Select Well Points
wells <- filter(Head_Points, Type == "well") %>% mutate(ID = as.factor(ID))

# Select GW Data from Wells
wdata <- Head_Data %>% 
  filter(str_detect(ID, "PM") | str_detect(ID,"MP")) %>% 
  mutate(DTW = -1*DTW, Date = ymd(Date), ID = as.factor(ID))

# Generate Monthly Precipitation Measurements
rgdata_monthly <- rgdata %>% 
  mutate(Month = month(Date), 
         Year = year(Date),
         ID = as.factor(ID)) %>% 
  group_by(ID, Year, Month) %>% 
  summarize(Value = sum(Value)) %>% 
  ungroup() %>% 
  mutate(Date = ymd(paste(Year,Month,"01",sep="-")),
         Unit = "mm/month") %>% 
  dplyr::select(ID, Date, Value, Unit)

# Define coordinate reference systems
crs32617 <- CRS("+proj=utm +zone=17 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
crs4326 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84")

# Create Spatial Well Points
wsp <- SpatialPointsDataFrame(
  coords = dplyr::select(wells, X, Y), 
  data   = dplyr::select(wells, ID, Z:LTP),
  proj4string = crs32617)

# Create Spatial Rain Gages
rgsp <- SpatialPointsDataFrame(
  coords = dplyr::select(rglocs, X, Y), 
  data   = dplyr::select(rglocs, ID, LoggerID, Province:Project),
  proj4string = crs32617)

# Transform Coordinates to Lat Lon
wsp_ll <- spTransform(wsp, crs4326)
rgsp_ll <- spTransform(rgsp, crs4326)
rivers_ll <- spTransform(rivers, crs4326)
geology_ll <- spTransform(geology, crs4326)
watersheds_ll <- spTransform(watersheds, crs4326)

# Add Labels for Wells
wsp_ll$New_Name <- 
  paste0('<strong>', wsp_ll$ID, '</strong>',
         '<br/>', 'Distrito: ', wsp_ll$District,
         '<br/>', 'Corregimiento: ', wsp_ll$Township, 
         '<br/>', 'Localidad: ', wsp_ll$Location) %>% 
  lapply(htmltools::HTML)

# Add Labels for Rain Gages
rgsp_ll$New_Name <- 
  paste0('<strong>', rgsp_ll$ID, '</strong>',
         '<br/>', 'Distrito: ', rgsp_ll$District,
         '<br/>', 'Corregimiento: ', rgsp_ll$Township, 
         '<br/>', 'Localidad: ', rgsp_ll$Location) %>% 
  lapply(htmltools::HTML)

# Add Labels for Geology
geology_ll$New_Name <- 
  paste0('<strong>', geology_ll$simbolo, '</strong>',
         '<br/>', 'Formas: ', geology_ll$formas,
         '<br/>', 'Grupo: ', geology_ll$grupo, 
         '<br/>', 'Formacion: ', geology_ll$formacion) %>% 
  lapply(htmltools::HTML)
```

Map
======================================

```{r}
# Create hydrograph function
hydrograph <- function(dataId, df, htype){
  dataFiltered <- filter(df, ID == dataId)
  if (htype == "gw") {
    fig <- ggplot(data = dataFiltered, mapping = aes(x=Date, y=DTW)) +
      geom_line(color = "dodgerblue") + geom_point(color = "dodgerblue") +
      ggtitle(paste0("Groundwater level measured at ",dataId)) +
      ylab("Depth to Water (m)")
  }
  else if (htype == "pp") {
    fig <- ggplot(dataFiltered) +
      geom_col(mapping = aes(x=Date, y=Value), fill = "dodgerblue") +
      ggtitle(paste0("Monthly total rainfall measured at ",dataId)) +
      ylab("Precipitation (mm/month)")
  }
  fig <- fig + 
    scale_x_date(date_labels = "%b %Y") +
    theme(axis.text.x = element_text(angle = 45))
  return(fig)
}

# Create function to plot leaflet map
make_map <- function(points, mygraph) {
  map <- leaflet(points) %>% 
    addTiles(group = "OSM") %>%
    addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
    addProviderTiles(providers$Esri.WorldImagery, group = "ESRI Imagery") %>%
    addProviderTiles(providers$Esri.WorldShadedRelief, group = "ESRI Relief") %>%
    addMarkers(label = ~ID, layerId = ~ID) %>%
    addLayersControl(baseGroups = c("OSM", "Toner Lite", "ESRI Imagery", "ESRI Relief"),
                     options = layersControlOptions(collapsed = TRUE)) %>%
    setView(lng = -80.1, lat = 8.4, zoom = 7.5) %>% 
    addPopupGraphs(graph = mygraph, group = "markers")
  return(map)
}

# Render leaflet map
renderLeaflet({
  if (input$pointTypeMap == "Monitoring Wells") {
    gw_pop <- lapply(wdata$ID, hydrograph, df=wdata, htype="gw")
    make_map(wsp_ll, gw_pop)
  }
  else if (input$pointTypeMap == "Rain Gages") {
    pp_pop <- lapply(rgdata_monthly$ID, hydrograph, df=rgdata_monthly, htype="pp")
    make_map(rgsp_ll, pp_pop)
  }
})


# Select what to map
absolutePanel(
  top = 10, left = 80,
  pickerInput(inputId = "pointTypeMap", 
              label = HTML("<b>Select what to render in map</b>"), 
              choices = c("Monitoring Wells","Rain Gages"),
              selected = "Monitoring Wells", width = "100%"),
  style = "background-color: white; 
           background-opacity: 0.65; 
           padding: 20px 20px 20px 20px;
           margin: auto;
           border-radius: 5pt;
           box-shadow: 0pt 0pt 6pt 0px rgba(61,59,61,0.48);
           padding-bottom: 2mm;
           padding-top: 1mm;",
)
```

```{r, echo = FALSE}
# When map is clicked, show a popup with plot
observe({
  leafletProxy("MyMap") %>% clearPopups()
  event <- input$map_marker_click
  if (is.null(event))
  return()
  isolate({
    showPopup(event$id, event$lat, event$lng)
  })
})

wdata
```


Data
======================================

Sidebar {.sidebar data-width=350}
-------------------------------------

### User Input
```{r}
## Select Type of Graph
pickerInput(inputId = "pointType", 
            label = "Select what to graph/plot", 
            choices = c("Monitoring Wells","Rain Gages"),
            selected = "Monitoring Wells", width = "100%")

## Select Well(s) or Rain Gauges(s)
renderUI({
  if (input$pointType == "Monitoring Wells") {
    selectInput(inputId = "id", 
                label = "Select monitoring well(s)", 
                choices = c("All", unique(as.character(wdata$ID))),
                selected = "All", multiple = T, width = "100%", 
                selectize = F, size = 6)
  } else if (input$pointType == "Rain Gages") {
    selectInput(inputId = "id", 
                label = "Select rain gauge(s)", 
                choices = c("All", unique(as.character(rgdata_monthly$ID))),
                selected = "All", multiple = T, width = "100%", 
                selectize = F, size = 6)
  }
})
```

### Map Output
```{r}
# Render Well Location
output$NewMap <- renderLeaflet({
  if (input$pointType == "Monitoring Wells") {
    points_sp <- wsp_ll
    points_data <- wdata
  } else if (input$pointType == "Rain Gages") {
    points_sp <- rgsp_ll
    points_data <- rgdata_monthly
  }
  if (input$id == "All") {
    p <- subset(points_sp, ID %in% unique(points_data$ID))
  }
  else {
    p <- subset(points_sp, ID %in% input$id)
  }
  leaflet(p, options = list(zoomControl = FALSE)) %>%
    addTiles(group = "OSM") %>%
    addMarkers(label = ~ID, layerId = ~ID)
})

# Confiure My Map
leafletOutput(outputId = "NewMap", height=300)
```


Row {.tabset data-width=650}
-------------------------------------

### Graph
```{r}
renderPlotly({
  if (input$pointType == "Monitoring Wells") {
    given_date_range <- c(as.Date("2015-05-01"), as.Date("2020-04-30"))
    yrange <- c(-24, 3)
    if (input$id == "All") {
      well_data_new <- group_by(wdata, ID) 
    } 
    else {
      well_data_new <- wdata %>% group_by(ID) %>% filter(ID %in% input$id)
    }
    fig <- well_data_new %>% 
      plot_ly(x = ~Date, y = ~DTW, 
              mode = "lines+markers",
              color = ~ID, colors="Dark2",
              xhoverformat = "%Y-%m-%d", text = ~ID,
              hovertemplate = paste('<b>%{text}</b>',
                                    '<br>DTW: %{y:.2f} m', 
                                    '<br>Date: %{x}'))
  }
  else if (input$pointType == "Rain Gages") {
    given_date_range <- c(as.Date("2018-06-01"), as.Date("2021-07-31"))
    yrange <- c(-20, max(rgdata_monthly$Value) + 50)
    if (input$id == "All") {
      rgdata_monthly_new <- group_by(rgdata_monthly, ID)
    } 
    else {
      rgdata_monthly_new <- rgdata_monthly %>% group_by(ID) %>% filter(ID %in% input$id)
    }
    fig <- rgdata_monthly_new %>% 
      plot_ly(x = ~Date, y = ~Value, type = "bar", color = ~ID, colors = "Set1")
  }
  fig %>% 
    layout(title = FALSE,
           showlegend = TRUE, 
           plot_bgcolor = "#DCDCDC",
           xaxis = list(title = "Date", 
                        tickformat = "%b %Y",
                        zerolinecolor = "#ffff",
                        gridcolor = "ffff",
                        range = given_date_range,
                        rangeslider = list(type = "date")),
           yaxis = list(title = "Depth to Water (m)",
                        zerolinecolor = "#ffff",
                        gridcolor = "ffff",
                        range = yrange)) %>% 
    config(displayModeBar = FALSE)
})
```

### Table

```{r}

```


About
======================================

### Historia

En mayo de 2015 se estableció la primera red de monitoreo de niveles piezométicos (niveles freáticos) del país en la cuenca del Río La Villa. Los datos son recolectados mensualmente por personal de la Dirección Regional de Herrera del IDAAN (Emilio Díaz, Karen Azcárraga) y personal del Deparatmento de Fuentes Subterráneas del IDAAN (Abel Castillo, Gilberto Sánchez).

### ¿Qué es ONASP?

El Observatorio Nacional de Aguas Subterráneas de Panamá (ONASP) es una iniciativa para compartir estos datos con los usiarios y tomadores de decisiones, para que cuenten con información acerca del comportamiento de las aguas subterráneas de la región.

Esta aplicación web fue diseñada utilizando [R](https://www.r-project.org/) y [Github Pages](https://pages.github.com/). La funcionalidad y aspecto de la página está basada en el Observatorio de Aguas Subterráneas de California (http://ucwater.org/gw_obs/) y el Observatorio de Calidad de Aguas Subterráneas de California (https://caccr.github.io/) ambos diseñados por [Rich Pauloo](https://richpauloo.github.io/).

El código fuente puede encontrarse [aquí](https://github.com/mgcastre/ONASP/tree/gh-pages).

&copy; 2022 por [María Gabriela Castrellón](https://github.com/mgcastre).