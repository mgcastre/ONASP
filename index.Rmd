---
title: "ONASP: Observatorio Nacional de Aguas Subterráneas de Panamá"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: cerulean
---

TODO:
*Filter Head Data (only want wells)
*Read Head Measurements
*Create Head Measurements Spatial Object
*Read Shapefiles From Database
*Delete Shapefiles Folder
*Push to origin
*Create new development branch
*Start adding some shinny functionality

```{r}
# Required Libraries
library(sp)
library(rgdal)
library(plotly)
library(magrittr)
library(tidyverse)
library(htmltools)
library(RColorBrewer)
library(RSQLite)
library(DBI)

# Open the database connection
objDB <- dbConnect(drv=SQLite(), dbname='Estibana_v5.sqlite')

# Read Head Data
Head_Data <- dbReadTable(objDB, "Head_Data") %>% filter(!is.na(date))
         
# Close the database connection
# dbDisconnect(objDB)
```


```{r global, include=FALSE}
# Required Libraries
library(sp)
library(rgdal)
library(plotly)
library(magrittr)
library(tidyverse)
library(htmltools)
library(RColorBrewer)
library(RSQLite)
library(DBI)

# Define Function to Plot Wells
plotWells <- function(data_table, p_name){
  # Creating Color Pallette
  n_pozos <- data_table$ID %>% unique() %>% length()
  pozos_pal <- colorRampPalette(brewer.pal(12,p_name))(n_pozos)
  
  # Plotting
  figure <- ggplot(data = data_table, mapping = aes(x = Date, y = NE)) + 
    geom_line(mapping = aes(color = ID), linetype = "dashed") +
    geom_point(mapping = aes(color = ID), shape = 15) +
    geom_smooth(color = "grey45") + theme_light() + 
    scale_colour_manual(values = pozos_pal) +
    scale_x_date(name = "Fecha", date_breaks = "3 months", date_labels = "%b %y") +
    labs(y = "Profundidad al Nivel Estático (m)", x = "Fecha")
  return(ggplotly(figure))
}

# Reproject Shapefiles
crs_char <- "+proj=longlat +datum=WGS84"
geologia <- spTransform(geologia, CRS(crs_char))
cuencas <- spTransform(cuencas, CRS(crs_char))
rios <- spTransform(rios, CRS(crs_char))
```


Information {.sidebar}
-------------------------------------

### Historia

En mayo de 2015 se estableció la primera red de monitoreo de niveles piezométicos (niveles freáticos) del país en la cuenca del Río La Villa. Los datos son recolectados mensualmente por personal de la Dirección Regional de Herrera del IDAAN (Emilio Díaz, Karen Azcárraga) y personal del Deparatmento de Fuentes Subterráneas del IDAAN (Abel Castillo, Gilberto Sánchez).

### ¿Qué es ONASP?

El Observatorio Nacional de Aguas Subterráneas de Panamá (ONASP) es una iniciativa para compartir estos datos con los usiarios y tomadores de decisiones, para que cuenten con información acerca del comportamiento de las aguas subterráneas de la región.

Esta aplicación web fue diseñada utilizando [R](https://www.r-project.org/) y [Github Pages](https://pages.github.com/). La funcionalidad y aspecto de la página está basada en el Observatorio de Aguas Subterráneas de California (http://ucwater.org/gw_obs/) y el Observatorio de Calidad de Aguas Subterráneas de California (https://caccr.github.io/) ambos diseñados por [Rich Pauloo](https://richpauloo.github.io/).

El código fuente puede encontrarse [aquí](https://github.com/mgcastre/ONASP/tree/gh-pages).

&copy; 2019 por [María Gabriela Castrellón](https://github.com/mgcastre).


Row {.tabset}
-------------------------------------

### Localización de Pozos

```{r}
# Add Labels for Wells
np_sp$New_Name <- 
  paste0('<strong>', np_sp$ID, '</strong>',
         '<br/>', 'Propietario: ', np_sp$Propietario,
         '<br/>', 'Corregimiento: ', np_sp$Corregimiento, 
         '<br/>', 'Profundidad: ', np_sp$Prof, " m") %>% 
  lapply(htmltools::HTML)

# Add Labels for Geology
geologia$New_Name <- 
  paste0('<strong>', geologia$SIMBOLO, '</strong>',
         '<br/>', 'Formas: ', geologia$FORMAS,
         '<br/>', 'Grupo: ', geologia$GRUPO, 
         '<br/>', 'Formacion: ', geologia$FORMACION) %>% 
  lapply(htmltools::HTML)

# Render Leaflet Interactive Map
leaflet(np_sp) %>%
  addTiles(group = "OSM") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI Imagery") %>%
  addProviderTiles(providers$Esri.WorldShadedRelief, group = "ESRI Relief") %>%
  addMarkers(popup = ~New_Name) %>%
  addPolygons(data = geologia, group = "Geología",
              popup = ~geologia$New_Name,
              stroke = TRUE, color = "black", opacity = 1,
              fill = TRUE, fillOpacity = 0.5, weight = 0.5,
              fillColor = ~colorFactor("YlOrBr", FORMAS)(FORMAS),
              highlightOptions = highlightOptions(color = "white", weight = 1.5, bringToFront = FALSE)) %>%
  addPolygons(data = cuencas, group = "Cuencas",
              stroke = TRUE, fill = FALSE, opacity = 1,
              color = "navy", weight = 3) %>%
  addPolylines(data = rios, group = "Ríos",
               color = "dodgerblue", weight = 2,
               opacity = 1, popup = ~rios$LABEL,
               highlightOptions = highlightOptions(color = "cyan", weight = 2.5)) %>%
  setView(lng = -80.5, lat = 8.6, zoom = 7.5) %>%
  addLayersControl(baseGroups = c("OSM", "Toner Lite", "ESRI Imagery", "ESRI Relief"),
                   overlayGroups = c("Cuencas","Geología","Ríos"),
                   options = layersControlOptions(collapsed = FALSE))
```


### Niveles Piezométricos

```{r}
# Create color palette
n_pozos <- np$ID %>% unique() %>% length()
pozos_pal <- colorRampPalette(brewer.pal(12,"Dark2"))(n_pozos)

# ggplot
figure <- left_join(np, ll, by = "ID") %>% 
  mutate(NE = -1*Value, ID = as.factor(ID)) %>% 
  highlight_key(~ID) %>% 
  ggplot(mapping = aes(x = Date, y = NE)) + 
  ggtitle("Niveles Piezométricos en Pozos de Observación") +
  geom_line(mapping = aes(color = ID)) +
  geom_point(mapping = aes(color = ID), size = 1.5) +
  geom_smooth(color = "grey45") + theme_light() +
  scale_colour_manual(values = pozos_pal) +
  scale_x_date(name = "Fecha", date_breaks = "3 months", date_labels = "%b %y") +
  labs(y = "Profundidad al Nivel Estático (m)", x = "Fecha") 

# plotly
ggplotly(figure) %>% 
  group_by(ID) %>%
  highlight(on = "plotly_hover", 
            off = "plotly_doubleclick",
            opacityDim = 0.2)
```

